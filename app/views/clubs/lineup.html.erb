<div class="min-h-screen" style="background-color: #f9fafb;">
  <div class="max-w-6xl mx-auto px-4 py-8">
    <!-- Header -->
    <div class="bg-white shadow-sm p-6 mb-6" style="border-radius: 12px;">
      <div style="display: flex; align-items: center; justify-content: space-between;">
        <div>
          <%= link_to "‚Üê Voltar ao Time", @club, class: "text-gray-600 hover:text-gray-800 font-medium mb-3 inline-block", style: "color: #6b7280; text-decoration: none; font-weight: 500; margin-bottom: 0.75rem; display: inline-block;" %>
          <div style="display: flex; align-items: center; gap: 1rem;">
            <div style="width: 64px; height: 64px; border-radius: 50%; background: linear-gradient(to right, #228B22, #32CD32); display: flex; align-items: center; justify-content: center;">
              <span style="font-size: 1.5rem; font-weight: 700; color: white;">‚öΩ</span>
            </div>
            <div>
              <h1 style="font-size: 1.875rem; font-weight: 700; color: #111827;"><%= @club.name %> - <%= t('lineups.title') %></h1>
              <p style="font-size: 1.125rem; color: #6b7280;"><%= @club.division&.name || "5¬™ Divis√£o" %></p>
            </div>
          </div>
        </div>
        <div style="text-align: right;">
          <p style="font-size: 0.875rem; color: #6b7280;">Titulares Selecionados</p>
          <p style="font-size: 1.5rem; font-weight: 700; color: #228B22;"><span id="starters-count">0</span>/11</p>
        </div>
      </div>
    </div>

    <%= form_with url: update_lineup_club_path(@club), method: :patch, local: true, id: "lineup-form" do |form| %>
      <!-- Jogadores por Posi√ß√£o -->
      <%
        position_groups = [
          { name: 'Goleiros', positions: ['GK'], color: '#228B22' },
          { name: 'Defesa', positions: ['CB', 'LB', 'RB'], color: '#0047AB' },
          { name: 'Meio-campo', positions: ['CDM', 'CM', 'CAM', 'LM', 'RM'], color: '#ea580c' },
          { name: 'Ataque', positions: ['LW', 'RW', 'ST'], color: '#dc2626' }
        ]
      %>

      <% position_groups.each do |group| %>
        <div class="bg-white shadow-sm p-6 mb-6" style="border-radius: 12px;">
          <h3 style="font-size: 1.125rem; font-weight: 600; margin-bottom: 1rem; color: <%= group[:color] %>;">
            <%= group[:name] %>
          </h3>

          <% group[:positions].each do |position| %>
            <% players = @players_by_position[position] || [] %>
            <% if players.any? %>
              <div class="mb-4">
                <h4 style="font-size: 0.875rem; font-weight: 600; color: #374151; margin-bottom: 0.5rem;">
                  <%= t("players.positions.#{position}") %> (<%= players.count %> jogadores)
                </h4>

                <div style="display: grid; gap: 0.5rem;">
                  <% players.each do |player| %>
                    <%
                      is_starter = @lineup_players.any? { |lp| lp.player_id == player.id && lp.starting }
                      position_text = case position
                                     when 'GK' then 'GOL'
                                     when 'CB' then 'ZAG'
                                     when 'LB', 'RB' then 'LAT'
                                     when 'CDM', 'CM', 'CAM' then 'MEI'
                                     when 'LW', 'RW', 'ST' then 'ATA'
                                     else position
                                     end
                    %>

                    <div class="player-card <%= is_starter ? 'starter' : '' %>"
                         data-player-id="<%= player.id %>"
                         data-position="<%= position %>"
                         style="display: flex; align-items: center; justify-content: space-between; padding: 1rem; border: 2px solid <%= is_starter ? '#22c55e' : '#e5e7eb' %>; border-radius: 8px; margin-bottom: 0.5rem; transition: all 0.2s; cursor: pointer; <%= is_starter ? 'background-color: #f0fdf4;' : '' %>"
                         onclick="togglePlayer(<%= player.id %>, '<%= position %>', this)">

                      <div style="display: flex; align-items: center; gap: 0.75rem;">
                        <span class="position-badge" style="padding: 0.25rem 0.5rem; border-radius: 4px; color: white; font-size: 0.75rem; font-weight: 600; background-color: <%= group[:color] %>;">
                          <%= position_text %>
                        </span>
                        <span style="font-weight: 500;"><%= player.name %></span>
                        <span style="font-size: 0.875rem; color: #6b7280;">üáßüá∑ Brasil</span>
                      </div>

                      <div style="display: flex; align-items: center; gap: 1rem;">
                        <div style="font-size: 0.875rem; color: #6b7280;">
                          F:<%= player.strength %> E:<%= player.stamina %> V:<%= player.speed %> A:<%= player.attack %> D:<%= player.defense %> P:<%= player.passing %>
                        </div>
                        <div style="font-weight: 600;"><%= player.overall %>‚≠ê</div>
                        <div class="starter-indicator" style="width: 20px; height: 20px; border: 2px solid #22c55e; border-radius: 50%; <%= is_starter ? 'background-color: #22c55e;' : 'background-color: white;' %>"></div>
                      </div>

                      <input type="hidden" name="players[<%= position %>_<%= player.id %>]" value="<%= player.id %>" <%= is_starter ? '' : 'disabled' %>>
                    </div>
                  <% end %>
                </div>
              </div>
            <% end %>
          <% end %>
        </div>
      <% end %>

      <!-- Bot√µes de A√ß√£o -->
      <div class="bg-white shadow-sm p-6" style="border-radius: 12px;">
        <div style="display: flex; gap: 1rem;">
          <%= form.submit "üíæ Salvar Escala√ß√£o", class: "btn", style: "flex: 1; padding: 0.75rem 1.5rem; border: none; border-radius: 8px; font-weight: 500; cursor: pointer; transition: all 0.2s; text-decoration: none; display: inline-block; text-align: center; background-color: #0047AB; color: white;" %>
          <button type="button" id="auto-select" style="flex: 1; padding: 0.75rem 1.5rem; border: none; border-radius: 8px; font-weight: 500; cursor: pointer; transition: all 0.2s; text-decoration: none; display: inline-block; text-align: center; background-color: #228B22; color: white;">
            üöÄ Auto Selecionar Melhores
          </button>
          <button type="button" id="clear-lineup" style="flex: 1; padding: 0.75rem 1.5rem; border: none; border-radius: 8px; font-weight: 500; cursor: pointer; transition: all 0.2s; text-decoration: none; display: inline-block; text-align: center; background-color: #dc2626; color: white;">
            üóëÔ∏è Limpar Escala√ß√£o
          </button>
        </div>
      </div>
    <% end %>
  </div>
</div>

<script>
  let startersCount = 0;
  let selectedPlayers = new Set();

  // Inicializar contadores
  document.addEventListener('DOMContentLoaded', function() {
    updateStartersCount();
  });

  function togglePlayer(playerId, position, element) {
    const input = element.querySelector('input');
    const indicator = element.querySelector('.starter-indicator');
    const isCurrentlyStarter = element.classList.contains('starter');

    if (isCurrentlyStarter) {
      // Remove from starters
      element.classList.remove('starter');
      element.style.borderColor = '#e5e7eb';
      element.style.backgroundColor = 'white';
      indicator.style.backgroundColor = 'white';
      input.disabled = true;
      selectedPlayers.delete(playerId);
      startersCount--;
    } else {
      // Add to starters (check limit)
      if (startersCount >= 11) {
        alert('Voc√™ s√≥ pode selecionar 11 titulares!');
        return;
      }

      element.classList.add('starter');
      element.style.borderColor = '#22c55e';
      element.style.backgroundColor = '#f0fdf4';
      indicator.style.backgroundColor = '#22c55e';
      input.disabled = false;
      selectedPlayers.add(playerId);
      startersCount++;
    }

    updateStartersCount();
  }

  function updateStartersCount() {
    const countElement = document.getElementById('starters-count');
    startersCount = document.querySelectorAll('.starter').length;
    countElement.textContent = startersCount;

    // Update color based on count
    if (startersCount === 11) {
      countElement.style.color = '#22c55e';
    } else if (startersCount > 11) {
      countElement.style.color = '#dc2626';
    } else {
      countElement.style.color = '#ea580c';
    }
  }

  // Auto select best players
  document.getElementById('auto-select').addEventListener('click', function() {
    // Clear current selection
    clearLineup();

    const positionLimits = {
      'GK': 1,
      'CB': 2,
      'LB': 1,
      'RB': 1,
      'CDM': 1,
      'CM': 2,
      'CAM': 1,
      'LM': 1,
      'RM': 1,
      'LW': 1,
      'RW': 1,
      'ST': 1
    };

    Object.keys(positionLimits).forEach(position => {
      const players = document.querySelectorAll(`[data-position="${position}"]`);
      const sortedPlayers = Array.from(players).sort((a, b) => {
        const overallA = parseInt(a.querySelector('[style*="font-weight: 600"]').textContent);
        const overallB = parseInt(b.querySelector('[style*="font-weight: 600"]').textContent);
        return overallB - overallA;
      });

      for (let i = 0; i < Math.min(positionLimits[position], sortedPlayers.length); i++) {
        const player = sortedPlayers[i];
        const playerId = parseInt(player.dataset.playerId);
        togglePlayer(playerId, position, player);
      }
    });

    alert('Melhores jogadores selecionados automaticamente!');
  });

  // Clear lineup
  document.getElementById('clear-lineup').addEventListener('click', function() {
    clearLineup();
  });

  function clearLineup() {
    document.querySelectorAll('.starter').forEach(element => {
      element.classList.remove('starter');
      element.style.borderColor = '#e5e7eb';
      element.style.backgroundColor = 'white';
      element.querySelector('.starter-indicator').style.backgroundColor = 'white';
      element.querySelector('input').disabled = true;
    });

    selectedPlayers.clear();
    startersCount = 0;
    updateStartersCount();
  }
</script>